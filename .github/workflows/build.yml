name: Build Canto-beats (Cross-platform)

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.1.0, etc.)
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build'
        required: true
        default: 'macos'
        type: choice
        options:
          - macos
          - windows
          - all

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'Canto-beats'

jobs:
  # =============================================================================
  # macOS Build (Apple Silicon)
  # =============================================================================
  build-macos:
    name: Build macOS (Apple Silicon)
    runs-on: macos-14  # Apple Silicon runner
    if: ${{ github.event_name == 'push' || inputs.platforms == 'macos' || inputs.platforms == 'all' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Apple Silicon
        run: |
          if [ "$(uname -m)" != "arm64" ]; then
            echo "ERROR: Not running on Apple Silicon!"
            exit 1
          fi
          echo "Running on Apple Silicon (arm64)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Homebrew dependencies
        run: brew install ffmpeg

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip wheel setuptools

          # Filter out incompatible packages
          grep -v -E "^#|llama-cpp-python|bitsandbytes" requirements.txt > requirements-ci.txt || true

          # Install PyTorch (Apple Silicon native)
          pip install torch torchaudio

          # Install other dependencies
          pip install -r requirements-ci.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")

          MLX_METALLIB=""
          if [ -f "$SITE_PACKAGES/mlx/lib/mlx.metallib" ]; then
            MLX_METALLIB="--add-data=$SITE_PACKAGES/mlx/lib/mlx.metallib:mlx/lib"
          fi

          python -m PyInstaller main.py \
            --onedir --windowed \
            --name="${{ env.APP_NAME }}" \
            --icon=public/icons/app_icon.icns \
            --add-data=src:src \
            --add-data=public:public \
            --hidden-import=PySide6.QtCore \
            --hidden-import=PySide6.QtGui \
            --hidden-import=PySide6.QtWidgets \
            --hidden-import=torch \
            --hidden-import=torchaudio \
            --hidden-import=faster_whisper \
            --hidden-import=transformers \
            --hidden-import=cryptography \
            --hidden-import=sentencepiece \
            --hidden-import=accelerate \
            --hidden-import=silero_vad \
            --hidden-import=mlx \
            --hidden-import=mlx.core \
            --hidden-import=mlx_whisper \
            --hidden-import=mlx_lm \
            --collect-all=mlx \
            --collect-all=mlx_whisper \
            --collect-all=mlx_lm \
            --hidden-import=opencc \
            --hidden-import=pysrt \
            --hidden-import=soundfile \
            --hidden-import=huggingface_hub \
            --hidden-import=objc \
            --hidden-import=AVFoundation \
            --hidden-import=cv2 \
            $MLX_METALLIB \
            --runtime-hook=rthooks/rthook_mlx.py \
            --osx-bundle-identifier=com.cantobeats.app \
            --target-arch=arm64 \
            --clean --noconfirm \
            --exclude-module=tkinter \
            --exclude-module=matplotlib

      - name: Post-build fixes and create DMG
        run: |
          APP_PATH="dist/${{ env.APP_NAME }}.app"

          # Fix MLX metallib symlinks
          if [ -f "$APP_PATH/Contents/Resources/mlx/lib/mlx.metallib" ]; then
            ln -sf "../Resources/mlx/lib/mlx.metallib" "$APP_PATH/Contents/Frameworks/mlx.metallib"
          fi

          # Remove quarantine and broken symlinks
          xattr -cr "$APP_PATH" || true
          find "$APP_PATH" -type l ! -exec test -e {} \; -delete 2>/dev/null || true

          # Create DMG
          mkdir -p dist/dmg
          cp -r "$APP_PATH" dist/dmg/
          ln -s /Applications dist/dmg/Applications

          hdiutil create -volname "${{ env.APP_NAME }}" \
            -srcfolder dist/dmg -ov -format UDZO \
            "dist/${{ env.APP_NAME }}-macOS.dmg"

          rm -rf dist/dmg
          ls -lh dist/*.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS
          path: dist/${{ env.APP_NAME }}-macOS.dmg
          retention-days: 30

  # =============================================================================
  # Windows Build (Placeholder - requires Windows-specific setup)
  # =============================================================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: ${{ github.event_name == 'push' || inputs.platforms == 'windows' || inputs.platforms == 'all' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip wheel setuptools

          # Filter incompatible packages for Windows
          # Note: MLX is Apple-only, need alternative for Windows
          (Get-Content requirements.txt) | Where-Object {
            $_ -notmatch "mlx|llama-cpp-python|bitsandbytes|pyobjc"
          } | Set-Content requirements-win.txt

          pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu121
          pip install -r requirements-win.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          python -m PyInstaller main.py `
            --onefile `
            --windowed `
            --name="${{ env.APP_NAME }}" `
            --icon=public/icons/app_icon.ico `
            --add-data="src;src" `
            --add-data="public;public" `
            --hidden-import=PySide6.QtCore `
            --hidden-import=PySide6.QtGui `
            --hidden-import=PySide6.QtWidgets `
            --hidden-import=torch `
            --hidden-import=faster_whisper `
            --hidden-import=transformers `
            --hidden-import=cryptography `
            --hidden-import=cv2 `
            --clean --noconfirm `
            --exclude-module=tkinter `
            --exclude-module=matplotlib

      - name: Verify build
        run: |
          if (Test-Path "dist/${{ env.APP_NAME }}.exe") {
            Get-Item "dist/${{ env.APP_NAME }}.exe" | Format-List
          } else {
            Write-Error "Build failed: exe not found"
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-Windows
          path: dist/${{ env.APP_NAME }}.exe
          retention-days: 30

  # =============================================================================
  # Create Release
  # =============================================================================
  create-release:
    name: Create Release
    needs: [build-macos]  # Add build-windows when ready
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS
          path: release

      # Uncomment when Windows build is ready
      # - name: Download Windows artifact
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: ${{ env.APP_NAME }}-Windows
      #     path: release

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ env.APP_NAME }} ${{ steps.version.outputs.version }}"
          files: release/*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
          generate_release_notes: true
          body: |
            ## Canto-beats ${{ steps.version.outputs.version }}

            ### Downloads
            - **macOS (Apple Silicon)**: `${{ env.APP_NAME }}-macOS.dmg`

            ### Installation
            #### macOS
            1. Download the DMG file
            2. Open DMG and drag to Applications
            3. First launch: Right-click > Open

            ### Requirements
            - macOS 12+ with Apple Silicon (M1/M2/M3/M4)
            - 8GB RAM minimum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
