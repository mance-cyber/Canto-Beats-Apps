name: Build macOS Only

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create Release'
        required: false
        default: false
        type: boolean
      notarize:
        description: 'Notarize (requires APPLE secrets)'
        required: false
        default: false
        type: boolean

jobs:
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Homebrew dependencies
        run: brew install mpv ffmpeg
      
      - name: Install Python dependencies
        run: |
          grep -v -E "llama-cpp-python|bitsandbytes" requirements.txt > requirements-macos.txt || true
          pip install --upgrade pip
          pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements-macos.txt
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          python -m PyInstaller main.py \
            --onedir \
            --windowed \
            --name=Canto-beats \
            --distpath=dist \
            --workpath=build \
            --specpath=. \
            --add-data=src:src \
            --add-data=public:public \
            --hidden-import=PySide6.QtCore \
            --hidden-import=PySide6.QtGui \
            --hidden-import=PySide6.QtWidgets \
            --hidden-import=torch \
            --hidden-import=faster_whisper \
            --hidden-import=transformers \
            --hidden-import=cryptography \
            --hidden-import=sentencepiece \
            --hidden-import=accelerate \
            --osx-bundle-identifier=com.cantobeats.app \
            --clean \
            --noconfirm \
            --exclude-module=tkinter \
            --exclude-module=matplotlib
      
      - name: Verify build output
        run: |
          echo "=== Build Output ==="
          ls -la dist/
          if [ -d "dist/Canto-beats.app" ]; then
            echo "Canto-beats.app created successfully"
            du -sh dist/Canto-beats.app
            file dist/Canto-beats.app/Contents/MacOS/Canto-beats
          else
            echo "Canto-beats.app not found!"
            exit 1
          fi
      
      - name: Create DMG
        run: |
          mkdir -p dist/dmg
          cp -r dist/Canto-beats.app dist/dmg/
          hdiutil create -volname "Canto-beats" -srcfolder dist/dmg -ov -format UDZO dist/Canto-beats-macOS.dmg
          echo "=== DMG Created ==="
          ls -lh dist/Canto-beats-macOS.dmg
      
      - name: Import Developer ID Certificate
        if: ${{ inputs.notarize }}
        env:
          CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
          CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          echo $CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm certificate.p12
      
      - name: Code Sign and Notarize
        if: ${{ inputs.notarize }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          python notarize_macos.py
          # Replace unsigned DMG with notarized version
          mv dist/Canto-beats-macOS-Notarized.dmg dist/Canto-beats-macOS.dmg
      
      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: Canto-beats-macOS-DMG
          path: dist/Canto-beats-macOS.dmg
          retention-days: 30
      
      - name: Upload macOS App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: Canto-beats-macOS-App
          path: dist/Canto-beats.app
          retention-days: 30

  create-release:
    name: Create Release (Optional)
    needs: build-macos
    runs-on: ubuntu-latest
    if: ${{ inputs.create_release }}
    
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Canto-beats-macOS-DMG
          path: release
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: macos-build-${{ steps.date.outputs.date }}
          name: "macOS Build ${{ steps.date.outputs.date }}"
          files: release/Canto-beats-macOS.dmg
          draft: false
          prerelease: true
          body: |
            ## macOS Build
            
            **Date:** ${{ steps.date.outputs.date }}
            
            ### Installation
            1. Download Canto-beats-macOS.dmg
            2. Open the DMG file
            3. Drag Canto-beats to Applications folder
            4. First run: Right-click > Open (to bypass Gatekeeper)
            
            ### Requirements
            - macOS 11 Big Sur or later
            - Apple Silicon (M1/M2/M3) - Native
            - Intel Mac - May work via Rosetta 2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
